## 概述
提供数据冗余
增加高可用性

## 复制集的历史

#### > 单点模式
优点：

    部署起来很方便
    节省资源

缺点：

    如果硬盘即将满了，怎么办
    如果出现网络通信故障或者机房电力故障，无法提供正常服务，怎么办
    如果进行备份时，为了保证数据的一致性，要将实例关闭或者上个写锁，来保证备份的有效性，怎么办

正是由于缺点的严重性，所以才出现复制集。

## 复制集
复制集是由一组拥有相同数据集的mongod实例所组成的集群。

#### > 按数据区分
    数据节点：存储数据，可以充当主从节点
    投票节点：负责选举，不存储数据，可以充当复制集节点，不能充当主从节点

#### > 按功能区分
    主节点：提供读写服务的节点
    从节点：提供读服务的节点
        隐藏节点：对程序不可见的节点
        延时节点：延时复制的节点
        '投票'节点：具有投票权的节点，不是Arbiter
    投票节点：Arbiter节点，无数据，仅作选举和充当复制集节点

#### > 规则
1. 一个应用只有一个主节点
2. 主节点接收所有客户端的写操作
3. 主节点的写操作，会记录到oplog中

## 复制集的特点
#### > 主节点是唯一的，但不是固定的
如果主节点发生故障，集群会通过选举来选举出一个合适的节点当作主节点<br/>
如果有一台机器的配置较好，可以修改配置文件增加这台机器当作主节点的优先级

#### > 大多数原则
集群存活节点小于等于二分之一时，集群只可读，不可写。
即使只有主节点存活，主节点也会因为这个原则而降为从节点。

#### > 从库无法写入
MySql从库的readonly对具有super权限的账户无效，
MongoDB完全杜绝了此种做法。

#### > 自动容灾
当主节点挂掉之后，集群会再选出一个主节点，不影响数据的写入。
当之前的主节点修复好之后，它会作为从节点，进行数据的复制，保证数据的一致性。

## 复制集环境搭建

创建如下格式文件夹

    |demo
    |--->data
    |------->28001
    |------->28002
    |------->28003
    |--->conf
    |------>28001.conf
    |------>28002.conf
    |------>28003.conf
    |--->log
    |------>28001.log
    |------>28002.log
    |------>28003.log

编写配置文件(28001.conf)

    bind_ip=192.168.1.102
    port=28001
    dbpath=data/28001/
    logpath=log/28001.log
    logappend=true
    fork=true //在windows下不能使用，需删除
    pidfilepath=data/28001/28001.pid
    oplogSize=1024
    replSet=IMOOC

启动服务

由于在配置文件中写的是相对路径，所以需要到demo文件夹下。<br/>
在demo文件夹下，执行 `mongod -f conf/28001.conf` 命令。

### > 复制集初始化

进入admin数据库

    mongo 192.168.1.102:28001/admin

编写配置命令

    config={
        _id:'IMOOC',
        members:[
            {_id:0,host:'192.168.1.102:28001'},
            {_id:1,host:'192.168.1.102:28002'},
            {_id:2,host:'192.168.1.102:28003'}
        ]
    }

修改配置文件(让28003成为投票节点)

    config.members[2] = {
        _id:2,
        host:'192.168.1.102:28003',
        arbiterOnly:true //投票节点
    }

应用配置文件

    rs.initiate(config)
    rs.reconfig(config) //应用修改过的配置文件

查看复制集的成员状态

    rs.status()
    rs.isMaster() //如果有隐藏节点，在该命令下不会显示

查看复制集成员配置信息

    rs.config()
    conf = rs.config()

主节点降为从节点

    rs.stepDown(5)

在复制集运行时添加节点，其它节点不用重启

    rs.add({_id:1,host:'192.168.1.102:28002'})

### > 验证复制集同步

连接主节点，创建数据库并插入数据

    use person
    db.student.insert({name:'张三',age:10})
    db.student.insert({name:'李四',age:10,gender:'男'})

连接从节点，查询数据

    rs.slaveOk(true) //查看从节点数据，需加上此句，否则报错
    use person
    db.student.find()

投票节点不存储任何物理数据

## 复制集成员配置参数

参数名|参数类型|示例|解释
:---:|:---:|---|---
_id|整数|_id:0
host|字符串|host:'192.168.1.102:28001'
arbiterOnly|布尔|arbiterOnly:true|是否成为投票节点
priority|整数|priority:0|优先级，取值0-1000，是否有资格成为主节点，0永远不能成为主节点
hidden|布尔|hidden:true|是否对程序可见，使用前需让priority=0，常用于备份
votes|整数|votes:1|该节点投票的票数，取值0或1
slaveDelay|整数|slaveDelay:3600|延时复制数据，单位：秒。常用于挽回损失
buildIndexes|布尔|buildIndexes:true|从节点只复制数据，不复制索引

## 复制集成员
- 主节点：priority至少为1
- 从节点：priority可以为0
- 延迟节点：priority为0 并且 hidden为true 并且 slaveDelay为XX
- 隐藏节点：priority为0 并且 hidden为true
- 无索引节点：priority为0 并且 buildIndexes为true

